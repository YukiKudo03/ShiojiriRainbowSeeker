# Implementation Log: Task 31

**Summary:** NotificationServiceを実装。プッシュ通知送信、虹アラート通知、スケジュール通知、通知一覧取得、通知設定管理機能を提供。静寂時間チェック、位置ベースの通知範囲フィルタリング、虹アラートのスロットリング（2時間）機能を含む。

**Timestamp:** 2026-01-22T16:41:15.510Z
**Log ID:** 45e78c46-abae-4df3-8e6b-183e88ec3ba5

---

## Statistics

- **Lines Added:** +750
- **Lines Removed:** -0
- **Files Changed:** 3
- **Net Change:** 750

## Files Modified
_No files modified_

## Files Created
- backend/app/services/notification_service.rb
- backend/app/jobs/scheduled_notification_job.rb
- backend/spec/services/notification_service_spec.rb

---

## Artifacts

### Functions

#### NotificationService#send_push_notification
- **Purpose:** 単一ユーザーにプッシュ通知を送信（静寂時間、通知設定チェック付き）
- **Location:** backend/app/services/notification_service.rb:56
- **Signature:** (user:, title:, body:, data: {}, notification_type: :system, options: {}) -> Hash
- **Exported:** Yes

#### NotificationService#send_rainbow_alert
- **Purpose:** 位置ベースのターゲティングで複数ユーザーに虹アラートを送信
- **Location:** backend/app/services/notification_service.rb:98
- **Signature:** (users:, location:, direction:, probability:, estimated_duration: nil, weather_summary: nil) -> Hash
- **Exported:** Yes

#### NotificationService#schedule_notification
- **Purpose:** 指定時刻に通知をスケジュール
- **Location:** backend/app/services/notification_service.rb:151
- **Signature:** (user:, title:, body:, deliver_at:, notification_type: :system, data: {}) -> Hash
- **Exported:** Yes

#### NotificationService#list_for_user
- **Purpose:** ユーザーの通知一覧をページネーション付きで取得
- **Location:** backend/app/services/notification_service.rb:177
- **Signature:** (user:, page: 1, per_page: 20, filter: nil) -> Hash
- **Exported:** Yes

#### NotificationService#get_settings
- **Purpose:** ユーザーの通知設定を取得
- **Location:** backend/app/services/notification_service.rb:203
- **Signature:** (user:) -> Hash
- **Exported:** Yes

#### NotificationService#update_settings
- **Purpose:** ユーザーの通知設定を更新
- **Location:** backend/app/services/notification_service.rb:217
- **Signature:** (user:, settings:) -> Hash
- **Exported:** Yes

#### NotificationService#mark_as_read
- **Purpose:** 通知を既読にマーク
- **Location:** backend/app/services/notification_service.rb:250
- **Signature:** (user:, notification_ids: nil) -> Hash
- **Exported:** Yes

### Classes

#### NotificationService
- **Purpose:** 通知送信のビジネスロジックを管理するサービスクラス
- **Location:** backend/app/services/notification_service.rb:23
- **Methods:** send_push_notification, send_rainbow_alert, schedule_notification, list_for_user, get_settings, update_settings, mark_as_read
- **Exported:** Yes

#### ScheduledNotificationJob
- **Purpose:** スケジュールされた通知を指定時刻に送信するバックグラウンドジョブ
- **Location:** backend/app/jobs/scheduled_notification_job.rb:21
- **Methods:** perform
- **Exported:** Yes

### Integrations

#### Integration
- **Description:** NotificationServiceはFcmClientとApnsClientを使用してiOS/Androidデバイスにプッシュ通知を送信
- **Frontend Component:** N/A
- **Backend Endpoint:** N/A (Service layer)
- **Data Flow:** NotificationService -> FcmClient/ApnsClient -> FCM/APNs -> Mobile devices

#### Integration
- **Description:** ScheduledNotificationJobはSolid Queueでキューイングされ、指定時刻にNotificationServiceを呼び出し
- **Frontend Component:** N/A
- **Backend Endpoint:** N/A (Background job)
- **Data Flow:** NotificationService.schedule_notification -> Solid Queue -> ScheduledNotificationJob.perform -> NotificationService.send_push_notification

