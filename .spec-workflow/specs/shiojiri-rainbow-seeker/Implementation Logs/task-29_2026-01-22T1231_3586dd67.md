# Implementation Log: Task 29

**Summary:** AnalysisServiceを実装。地域統計（region_stats）、虹出現傾向分析（rainbow_trends）、気象条件相関（weather_correlations）、データエクスポート（export_dataset）、地域比較（compare_regions）機能を提供。大量データの場合はバックグラウンドジョブでエクスポート。塩尻市の大門地区、中心部、全域の事前定義リージョンを含む。

**Timestamp:** 2026-01-22T12:31:47.784Z
**Log ID:** 3586dd67-7259-47a6-a4ca-9531851109ba

---

## Statistics

- **Lines Added:** +900
- **Lines Removed:** -0
- **Files Changed:** 2
- **Net Change:** 900

## Files Modified
_No files modified_

## Files Created
- backend/app/services/analysis_service.rb
- backend/spec/services/analysis_service_spec.rb

---

## Artifacts

### Functions

#### region_stats
- **Purpose:** 指定地域の虹目撃統計（総数、ユーザー数、気象統計、時間帯分布）
- **Location:** backend/app/services/analysis_service.rb:46
- **Signature:** (region_id:, period: {}, center: nil, radius: nil) -> Hash
- **Exported:** Yes

#### rainbow_trends
- **Purpose:** 虹出現トレンドの時系列分析（日/週/月/年単位）
- **Location:** backend/app/services/analysis_service.rb:75
- **Signature:** (period: {}, group_by: 'month', region_id: nil) -> Hash
- **Exported:** Yes

#### weather_correlations
- **Purpose:** 気象条件と虹出現の相関分析
- **Location:** backend/app/services/analysis_service.rb:100
- **Signature:** (period: {}, region_id: nil) -> Hash
- **Exported:** Yes

#### export_dataset
- **Purpose:** 研究用データセットのエクスポート（JSON/CSV）
- **Location:** backend/app/services/analysis_service.rb:123
- **Signature:** (period: {}, region_id: nil, format: 'json', include_weather: true) -> Hash
- **Exported:** Yes

#### compare_regions
- **Purpose:** 複数地域の統計比較・ランキング
- **Location:** backend/app/services/analysis_service.rb:155
- **Signature:** (region_ids:, period: {}) -> Hash
- **Exported:** Yes

### Classes

#### AnalysisService
- **Purpose:** 虹出現パターン分析・地域統計・データエクスポート機能
- **Location:** backend/app/services/analysis_service.rb
- **Methods:** region_stats, rainbow_trends, weather_correlations, export_dataset, compare_regions
- **Exported:** Yes

### Integrations

#### Integration
- **Description:** 事前定義リージョン（大門地区3km、塩尻市中心部5km、全域15km）での統計分析
- **Frontend Component:** RegionStatsModal
- **Backend Endpoint:** AnalysisService#region_stats
- **Data Flow:** リクエスト → region_stats → PostGIS within_radius → 統計計算 → 30分キャッシュ → 結果返却

#### Integration
- **Description:** 10,000件超の大量データエクスポートはバックグラウンドジョブで処理
- **Frontend Component:** DataExportButton
- **Backend Endpoint:** AnalysisService#export_dataset
- **Data Flow:** リクエスト → レコード数カウント → 10,000件超えなら同期処理 / 超えたらジョブキュー登録 → job_id返却

