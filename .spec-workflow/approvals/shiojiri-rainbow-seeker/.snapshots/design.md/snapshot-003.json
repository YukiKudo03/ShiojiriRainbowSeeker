{
  "id": "snapshot_1768936304344_nfl2tqnyk",
  "approvalId": "approval_1768935725436_kk5go7a2o",
  "approvalTitle": "塩尻レインボーシーカー 設計書（Ruby on Rails 8版）",
  "version": 3,
  "timestamp": "2026-01-20T19:11:44.344Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# 設計書\n\n## 概要\n\n塩尻レインボーシーカー（ShiojiriRainbowSeeker）は、虹の写真共有、虹出現通知、および虹出現地域分析の3つの主要機能を提供するモバイルアプリケーションです。本設計書では、クロスプラットフォームモバイルアプリ（React Native）とバックエンドAPI（Ruby on Rails 8）、およびデータベース（PostgreSQL/PostGIS）を用いたシステムアーキテクチャを定義します。\n\n### 設計の基本方針\n- **モジュラー設計**: 各機能を独立したモジュールとして実装し、保守性と拡張性を確保\n- **オフラインファースト**: ネットワーク接続がない状態でも基本的な操作を可能にする\n- **スケーラブル**: 将来のユーザー数増加や機能拡張に対応できる設計\n- **セキュアバイデザイン**: セキュリティを設計段階から組み込む\n\n## ステアリングドキュメントとの整合性\n\n### 技術標準（tech.md）\n本プロジェクトは新規開発のため、以下の技術スタックを採用します：\n- **フロントエンド**: React Native（iOS/Android対応）\n- **バックエンド**: Ruby on Rails 8（API モード）\n- **データベース**: PostgreSQL + PostGIS（地理空間データ対応）\n- **認証**: Devise + JWT（JSON Web Token）\n- **API設計**: RESTful API（Rails標準）\n- **画像ストレージ**: Active Storage + AWS S3 + CloudFront CDN\n- **バックグラウンドジョブ**: Solid Queue（Rails 8標準）\n- **キャッシュ**: Solid Cache（Rails 8標準）\n\n### プロジェクト構造（structure.md）\n```\nshiojiri-rainbow-seeker/\n├── mobile/                          # React Nativeモバイルアプリ\n│   ├── src/\n│   │   ├── components/              # 再利用可能なUIコンポーネント\n│   │   ├── screens/                 # 画面コンポーネント\n│   │   ├── navigation/              # ナビゲーション設定\n│   │   ├── services/                # APIクライアント、外部サービス連携\n│   │   ├── hooks/                   # カスタムフック\n│   │   ├── store/                   # 状態管理（Redux/Zustand）\n│   │   ├── utils/                   # ユーティリティ関数\n│   │   ├── types/                   # TypeScript型定義\n│   │   ├── i18n/                    # 国際化（日本語/英語）\n│   │   └── assets/                  # 画像、フォント等\n│   └── __tests__/                   # テストファイル\n├── backend/                         # Ruby on Rails 8 API\n│   ├── app/\n│   │   ├── controllers/\n│   │   │   └── api/\n│   │   │       └── v1/              # APIバージョニング\n│   │   │           ├── auth_controller.rb\n│   │   │           ├── photos_controller.rb\n│   │   │           ├── users_controller.rb\n│   │   │           ├── notifications_controller.rb\n│   │   │           ├── maps_controller.rb\n│   │   │           └── admin/       # 管理者用コントローラ\n│   │   ├── models/                  # Active Recordモデル\n│   │   │   ├── user.rb\n│   │   │   ├── photo.rb\n│   │   │   ├── weather_condition.rb\n│   │   │   ├── radar_data.rb\n│   │   │   ├── comment.rb\n│   │   │   ├── like.rb\n│   │   │   ├── notification.rb\n│   │   │   └── report.rb\n│   │   ├── services/                # ビジネスロジック（Service Objects）\n│   │   │   ├── auth_service.rb\n│   │   │   ├── photo_service.rb\n│   │   │   ├── weather_service.rb\n│   │   │   ├── notification_service.rb\n│   │   │   └── analysis_service.rb\n│   │   ├── jobs/                    # Solid Queueジョブ\n│   │   │   ├── weather_fetch_job.rb\n│   │   │   ├── rainbow_alert_job.rb\n│   │   │   ├── image_processing_job.rb\n│   │   │   └── data_export_job.rb\n│   │   ├── serializers/             # JSONシリアライザ（Alba/Blueprinter）\n│   │   ├── validators/              # カスタムバリデータ\n│   │   └── mailers/                 # メール送信\n│   ├── config/\n│   │   ├── routes.rb                # ルーティング\n│   │   └── initializers/            # 初期設定\n│   ├── db/\n│   │   ├── migrate/                 # マイグレーション\n│   │   └── seeds.rb                 # シードデータ\n│   ├── lib/\n│   │   └── external_apis/           # 外部API連携モジュール\n│   │       ├── weather_api.rb\n│   │       ├── radar_api.rb\n│   │       └── geocoding_api.rb\n│   └── spec/                        # RSpecテスト\n│       ├── models/\n│       ├── requests/\n│       ├── services/\n│       └── jobs/\n└── shared/                          # 共有定数・設定\n```\n\n## コード再利用分析\n\n### 新規プロジェクトのため活用する外部ライブラリ\n\n#### モバイルアプリ（React Native）\n- **react-native-maps**: マップ表示、マーカー、クラスタリング\n- **react-native-camera / expo-camera**: カメラ機能\n- **react-native-image-picker**: 画像選択\n- **@react-native-community/geolocation**: GPS位置取得\n- **react-native-push-notification / expo-notifications**: プッシュ通知\n- **@react-navigation/native**: 画面遷移\n- **react-native-chart-kit**: グラフ表示（気象データ可視化）\n- **i18next / react-i18next**: 多言語対応\n- **zustand / redux-toolkit**: 状態管理\n- **react-query / tanstack-query**: サーバー状態管理\n- **async-storage**: ローカルストレージ\n\n#### バックエンド（Ruby on Rails 8）\n- **devise**: 認証基盤\n- **devise-jwt**: JWT認証\n- **bcrypt**: パスワードハッシュ\n- **active_storage**: ファイルアップロード（Rails標準）\n- **aws-sdk-s3**: S3連携\n- **image_processing / vips**: 画像圧縮・リサイズ\n- **solid_queue**: バックグラウンドジョブ（Rails 8標準）\n- **solid_cache**: キャッシュ（Rails 8標準）\n- **activerecord-postgis-adapter**: PostGIS対応\n- **rgeo / rgeo-geojson**: 地理空間データ処理\n- **alba / blueprinter**: JSONシリアライザ\n- **rack-cors**: CORS設定\n- **pundit**: 認可\n- **kaminari**: ページネーション\n- **fcm / rpush**: プッシュ通知\n- **suncalc-ruby**: 太陽位置計算\n- **httparty / faraday**: HTTP クライアント\n- **rails-i18n**: 国際化\n\n### 統合ポイント\n\n| 外部サービス | 用途 | 統合方法 |\n|-------------|------|----------|\n| OpenWeatherMap API | 気象データ取得 | Faraday HTTP クライアント |\n| 気象庁API / RainViewer | 雨雲レーダーデータ | Faraday HTTP クライアント |\n| AWS S3 | 画像ストレージ | Active Storage + aws-sdk-s3 |\n| CloudFront CDN | 画像配信 | S3連携 |\n| Firebase Cloud Messaging | Androidプッシュ通知 | fcm gem |\n| Apple Push Notification | iOSプッシュ通知 | rpush gem |\n| SendGrid | メール送信 | Action Mailer + sendgrid-ruby |\n| Google Maps / Mapbox | 地図表示・ジオコーディング | React Native SDK + geocoder gem |\n\n## アーキテクチャ\n\n### システム全体アーキテクチャ\n\n```mermaid\ngraph TB\n    subgraph \"モバイルアプリ（React Native）\"\n        MA[メインアプリ]\n        MA --> AUTH_S[認証画面]\n        MA --> FEED_S[フィード画面]\n        MA --> MAP_S[マップ画面]\n        MA --> CAMERA_S[カメラ画面]\n        MA --> PROFILE_S[プロフィール画面]\n        MA --> SETTINGS_S[設定画面]\n    end\n\n    subgraph \"バックエンドAPI（Ruby on Rails 8）\"\n        API[Rails API Router]\n        API --> AUTH_C[Api::V1::AuthController]\n        API --> PHOTO_C[Api::V1::PhotosController]\n        API --> USER_C[Api::V1::UsersController]\n        API --> NOTIF_C[Api::V1::NotificationsController]\n        API --> MAP_C[Api::V1::MapsController]\n        API --> SOCIAL_C[Api::V1::SocialController]\n    end\n\n    subgraph \"サービス層（Service Objects）\"\n        AUTH_SVC[AuthService]\n        PHOTO_SVC[PhotoService]\n        WEATHER_SVC[WeatherService]\n        NOTIF_SVC[NotificationService]\n        ANALYSIS_SVC[AnalysisService]\n    end\n\n    subgraph \"ジョブ層（Solid Queue）\"\n        WEATHER_JOB[WeatherFetchJob]\n        ALERT_JOB[RainbowAlertJob]\n        IMAGE_JOB[ImageProcessingJob]\n        EXPORT_JOB[DataExportJob]\n    end\n\n    subgraph \"データ層\"\n        DB[(PostgreSQL + PostGIS)]\n        CACHE[(Solid Cache)]\n        S3[(AWS S3 / Active Storage)]\n    end\n\n    subgraph \"外部サービス\"\n        WEATHER_API[気象API]\n        RADAR_API[雨雲レーダーAPI]\n        FCM[Firebase Cloud Messaging]\n        APNS[Apple Push Notification]\n        EMAIL[SendGrid]\n    end\n\n    MA <--> API\n    AUTH_C --> AUTH_SVC\n    PHOTO_C --> PHOTO_SVC\n    MAP_C --> WEATHER_SVC\n    NOTIF_C --> NOTIF_SVC\n\n    AUTH_SVC --> DB\n    PHOTO_SVC --> DB\n    PHOTO_SVC --> S3\n    PHOTO_SVC --> IMAGE_JOB\n    WEATHER_SVC --> WEATHER_API\n    WEATHER_SVC --> RADAR_API\n    WEATHER_SVC --> CACHE\n    WEATHER_SVC --> DB\n    WEATHER_SVC --> WEATHER_JOB\n    NOTIF_SVC --> FCM\n    NOTIF_SVC --> APNS\n    NOTIF_SVC --> EMAIL\n    NOTIF_SVC --> ALERT_JOB\n    ANALYSIS_SVC --> DB\n```\n\n### Rails 8 の新機能活用\n\n- **Solid Queue**: デフォルトのジョブバックエンド。Redis不要で、PostgreSQLで動作\n- **Solid Cache**: デフォルトのキャッシュストア。Redis不要で、PostgreSQLで動作\n- **Kamal 2**: デプロイメント自動化（Docker + SSH）\n- **Propshaft**: アセットパイプライン（API モードでは軽量）\n- **Thruster**: 本番環境での高速HTTPサーバー\n\n### モジュラー設計原則\n\n- **単一ファイル責任**: 各ファイルは1つの明確な責務のみを持つ\n- **Service Objects**: ビジネスロジックをコントローラから分離\n- **コンポーネント分離**: 小さく焦点を絞ったコンポーネントを作成\n- **Concerns**: 共通ロジックをモジュールとして抽出\n- **ユーティリティモジュール化**: 汎用機能は単一目的のモジュールに分割\n\n### データフロー\n\n```mermaid\nsequenceDiagram\n    participant User as ユーザー\n    participant App as モバイルアプリ\n    participant API as Rails API\n    participant Job as Solid Queue\n    participant DB as PostgreSQL\n    participant S3 as Active Storage/S3\n    participant Weather as 気象API\n\n    Note over User, Weather: 虹の写真アップロードフロー\n    User->>App: 写真撮影/選択\n    App->>App: GPS位置取得\n    App->>App: 画像圧縮\n    App->>API: POST /api/v1/photos\n    API->>S3: Active Storage で画像アップロード\n    S3-->>API: blob URL\n    API->>DB: 写真レコード作成\n    API->>Job: WeatherFetchJob をキュー登録\n    API-->>App: 成功レスポンス（写真ID）\n    App-->>User: アップロード完了通知\n\n    Note over Job, Weather: バックグラウンド処理\n    Job->>Weather: 気象データ取得（前後3時間）\n    Weather-->>Job: 気象条件データ\n    Job->>DB: 気象データ保存\n```\n\n## コンポーネントとインターフェース\n\n### モバイルアプリ コンポーネント\n\n#### 画面コンポーネント\n\n##### AuthScreen（認証画面）\n- **目的**: ユーザーのログイン・登録・パスワードリセット\n- **インターフェース**:\n  - `login(email, password): Promise<User>`\n  - `register(email, password, displayName): Promise<User>`\n  - `resetPassword(email): Promise<void>`\n- **依存**: AuthService, ValidationUtils\n- **要件参照**: FR-1\n\n##### FeedScreen（フィード画面）\n- **目的**: 虹の写真フィードの表示、フィルタリング、検索\n- **インターフェース**:\n  - `fetchPhotos(page, filters): Promise<Photo[]>`\n  - `filterByLocation(lat, lng, radius): void`\n  - `filterByDateRange(start, end): void`\n  - `searchByKeyword(keyword): void`\n- **依存**: PhotoService, LocationService\n- **要件参照**: FR-4\n\n##### MapScreen（マップ画面）\n- **目的**: 地図上に虹の目撃情報を表示、ヒートマップ\n- **インターフェース**:\n  - `loadMarkers(bounds): Promise<Marker[]>`\n  - `showHeatmap(): void`\n  - `showRegionStats(regionId): Promise<RegionStats>`\n- **依存**: MapService, AnalysisService\n- **要件参照**: FR-5, FR-13\n\n##### CameraScreen（カメラ画面）\n- **目的**: 虹の写真撮影、ギャラリー選択、位置タグ付け\n- **インターフェース**:\n  - `capturePhoto(): Promise<PhotoData>`\n  - `selectFromGallery(): Promise<PhotoData>`\n  - `setLocation(lat, lng): void`\n  - `uploadPhoto(photoData, metadata): Promise<Photo>`\n- **依存**: CameraService, LocationService, PhotoService\n- **要件参照**: FR-2, FR-3\n\n##### PhotoDetailScreen（写真詳細画面）\n- **目的**: 写真の詳細表示、気象条件データ、コメント\n- **インターフェース**:\n  - `getPhotoDetail(photoId): Promise<PhotoDetail>`\n  - `getWeatherData(photoId): Promise<WeatherData>`\n  - `likePhoto(photoId): Promise<void>`\n  - `addComment(photoId, content): Promise<Comment>`\n- **依存**: PhotoService, WeatherService, SocialService\n- **要件参照**: FR-3, FR-8, FR-13\n\n##### ProfileScreen（プロフィール画面）\n- **目的**: ユーザープロフィール管理、自分の写真一覧\n- **インターフェース**:\n  - `getUserProfile(): Promise<UserProfile>`\n  - `updateProfile(data): Promise<UserProfile>`\n  - `getMyPhotos(page): Promise<Photo[]>`\n  - `deletePhoto(photoId): Promise<void>`\n- **依存**: UserService, PhotoService\n- **要件参照**: FR-9\n\n##### SettingsScreen（設定画面）\n- **目的**: 通知設定、プライバシー設定、アカウント管理\n- **インターフェース**:\n  - `getSettings(): Promise<Settings>`\n  - `updateNotificationSettings(settings): Promise<void>`\n  - `exportData(): Promise<string>`\n  - `deleteAccount(): Promise<void>`\n- **依存**: SettingsService, NotificationService\n- **要件参照**: FR-7, FR-12\n\n#### 共通UIコンポーネント\n\n| コンポーネント | 目的 | Props |\n|---------------|------|-------|\n| PhotoCard | 写真カードの表示 | photo, onPress, onLike |\n| PhotoGrid | 写真のグリッド表示 | photos, columns, onPhotoPress |\n| MapMarker | マップマーカー | location, count, onPress |\n| ClusteredMap | クラスタリング地図 | markers, onMarkerPress |\n| WeatherChart | 気象データグラフ | weatherData, timeRange |\n| RadarAnimation | 雨雲レーダーアニメーション | radarData, timestamps |\n| CommentList | コメント一覧 | comments, onReply |\n| LocationPicker | 位置選択マップ | initialLocation, onSelect |\n| LoadingSpinner | ローディング表示 | size, color |\n| ErrorBoundary | エラー境界 | fallback, onError |\n\n### バックエンドAPI コンポーネント（Ruby on Rails 8）\n\n#### コントローラー\n\n##### Api::V1::AuthController\n- **目的**: 認証エンドポイント処理\n- **エンドポイント**:\n  - `POST /api/v1/auth/register` - ユーザー登録\n  - `POST /api/v1/auth/login` - ログイン\n  - `DELETE /api/v1/auth/logout` - ログアウト\n  - `POST /api/v1/auth/refresh` - トークンリフレッシュ\n  - `POST /api/v1/auth/password/reset` - パスワードリセット要求\n  - `PUT /api/v1/auth/password/reset` - パスワードリセット確認\n  - `GET /api/v1/auth/verify_email/:token` - メール認証\n- **要件参照**: FR-1\n\n##### Api::V1::PhotosController\n- **目的**: 写真関連エンドポイント処理\n- **エンドポイント**:\n  - `GET /api/v1/photos` - 写真一覧取得（ページネーション、フィルタ対応）\n  - `GET /api/v1/photos/:id` - 写真詳細取得\n  - `POST /api/v1/photos` - 写真アップロード\n  - `PATCH /api/v1/photos/:id` - 写真情報更新\n  - `DELETE /api/v1/photos/:id` - 写真削除\n  - `GET /api/v1/photos/:id/weather` - 気象条件データ取得\n- **要件参照**: FR-2, FR-3, FR-4, FR-13\n\n##### Api::V1::MapsController\n- **目的**: 地図関連エンドポイント処理\n- **エンドポイント**:\n  - `GET /api/v1/maps/markers` - 範囲内のマーカー取得\n  - `GET /api/v1/maps/clusters` - クラスタリングされたマーカー取得\n  - `GET /api/v1/maps/heatmap` - ヒートマップデータ取得\n  - `GET /api/v1/maps/regions/:id/stats` - 地域統計取得\n- **要件参照**: FR-5, FR-13\n\n##### Api::V1::SocialController\n- **目的**: ソーシャル機能エンドポイント処理\n- **エンドポイント**:\n  - `POST /api/v1/photos/:photo_id/likes` - いいね\n  - `DELETE /api/v1/photos/:photo_id/likes` - いいね解除\n  - `GET /api/v1/photos/:photo_id/comments` - コメント一覧\n  - `POST /api/v1/photos/:photo_id/comments` - コメント投稿\n  - `POST /api/v1/photos/:photo_id/reports` - 不適切コンテンツ報告\n- **要件参照**: FR-8\n\n##### Api::V1::NotificationsController\n- **目的**: 通知関連エンドポイント処理\n- **エンドポイント**:\n  - `GET /api/v1/notifications` - 通知一覧\n  - `PATCH /api/v1/notifications/:id/read` - 既読マーク\n  - `GET /api/v1/notifications/settings` - 通知設定取得\n  - `PATCH /api/v1/notifications/settings` - 通知設定更新\n- **要件参照**: FR-6, FR-7\n\n##### Api::V1::UsersController\n- **目的**: ユーザー関連エンドポイント処理\n- **エンドポイント**:\n  - `GET /api/v1/users/me` - 自分のプロフィール取得\n  - `PATCH /api/v1/users/me` - プロフィール更新\n  - `GET /api/v1/users/me/photos` - 自分の写真一覧\n  - `POST /api/v1/users/me/export` - データエクスポート要求\n  - `DELETE /api/v1/users/me` - アカウント削除\n- **要件参照**: FR-9, FR-12\n\n##### Api::V1::Admin::ReportsController\n- **目的**: 管理者機能エンドポイント処理\n- **エンドポイント**:\n  - `GET /api/v1/admin/reports` - 報告一覧\n  - `PATCH /api/v1/admin/reports/:id` - 報告処理（承認/非表示/削除）\n  - `GET /api/v1/admin/users` - ユーザー一覧\n  - `PATCH /api/v1/admin/users/:id/status` - ユーザーステータス変更\n- **要件参照**: FR-10\n\n#### サービス層（Service Objects）\n\n##### AuthService\n```ruby\nclass AuthService\n  def register(email:, password:, display_name:)\n    # ユーザー作成、メール認証送信\n  end\n\n  def login(email:, password:)\n    # 認証、JWTトークン発行\n  end\n\n  def verify_email(token:)\n    # メール認証処理\n  end\n\n  def refresh_token(refresh_token:)\n    # トークンリフレッシュ\n  end\n\n  def reset_password(email:)\n    # パスワードリセット要求\n  end\n\n  def confirm_password_reset(token:, new_password:)\n    # パスワードリセット確認\n  end\nend\n```\n\n##### PhotoService\n```ruby\nclass PhotoService\n  def create(user:, image:, metadata:)\n    # 写真作成、Active Storage アップロード、WeatherFetchJob キュー登録\n  end\n\n  def find_with_details(photo_id:)\n    # 写真詳細取得（気象データ含む）\n  end\n\n  def list(filters:, page:, per_page:)\n    # フィルタ・ページネーション対応一覧\n  end\n\n  def update(photo:, params:)\n    # 写真情報更新\n  end\n\n  def destroy(photo:)\n    # 写真削除（Active Storage も削除）\n  end\n\n  def weather_data(photo_id:)\n    # 気象条件データ取得\n  end\nend\n```\n\n##### WeatherService\n```ruby\nclass WeatherService\n  def fetch_current_conditions(lat:, lng:)\n    # 現在の気象条件取得\n  end\n\n  def fetch_historical_data(lat:, lng:, start_time:, end_time:)\n    # 履歴気象データ取得（前後3時間）\n  end\n\n  def fetch_radar_data(lat:, lng:, timestamps:)\n    # 雨雲レーダーデータ取得\n  end\n\n  def calculate_sun_position(lat:, lng:, time:)\n    # 太陽位置計算（suncalc-ruby使用）\n  end\n\n  def check_rainbow_conditions(lat:, lng:)\n    # 虹条件チェック\n  end\nend\n```\n\n##### NotificationService\n```ruby\nclass NotificationService\n  def send_push_notification(user:, payload:)\n    # プッシュ通知送信（FCM/APNs）\n  end\n\n  def send_rainbow_alert(user_ids:, condition:)\n    # 虹アラート一斉送信\n  end\n\n  def schedule_notification(notification:, scheduled_at:)\n    # 通知スケジュール\n  end\n\n  def list_for_user(user:, page:, per_page:)\n    # ユーザーの通知一覧\n  end\nend\n```\n\n##### AnalysisService\n```ruby\nclass AnalysisService\n  def region_stats(region_id:)\n    # 地域統計取得\n  end\n\n  def heatmap_data(bounds:)\n    # ヒートマップデータ生成\n  end\n\n  def rainbow_trends(region_id:)\n    # 虹出現傾向分析\n  end\n\n  def export_dataset(filters:)\n    # データセットエクスポート（機械学習用）\n  end\nend\n```\n\n## データモデル\n\n### User（ユーザー）\n```ruby\n# app/models/user.rb\nclass User < ApplicationRecord\n  # Devise モジュール\n  devise :database_authenticatable, :registerable, :recoverable,\n         :rememberable, :validatable, :confirmable, :jwt_authenticatable,\n         jwt_revocation_strategy: JwtDenylist\n\n  # Active Storage\n  has_one_attached :profile_image\n\n  # アソシエーション\n  has_many :photos, dependent: :destroy\n  has_many :comments, dependent: :destroy\n  has_many :likes, dependent: :destroy\n  has_many :notifications, dependent: :destroy\n  has_many :device_tokens, dependent: :destroy\n\n  # バリデーション\n  validates :display_name, presence: true, length: { in: 3..30 }\n  validates :locale, inclusion: { in: %w[ja en] }\n\n  # Enum\n  enum :role, { user: 0, admin: 1 }\n\n  # 属性\n  # id: uuid\n  # email: string (unique)\n  # encrypted_password: string\n  # display_name: string\n  # role: integer (default: 0)\n  # notification_settings: jsonb (default: {})\n  # locale: string (default: 'ja')\n  # created_at, updated_at, deleted_at (論理削除)\nend\n```\n\n### Photo（写真）\n```ruby\n# app/models/photo.rb\nclass Photo < ApplicationRecord\n  # Active Storage\n  has_one_attached :image\n  has_one_attached :thumbnail\n\n  # アソシエーション\n  belongs_to :user\n  has_many :weather_conditions, dependent: :destroy\n  has_many :radar_data, dependent: :destroy\n  has_many :comments, dependent: :destroy\n  has_many :likes, dependent: :destroy\n  has_many :reports, as: :reportable, dependent: :destroy\n\n  # PostGIS 地理空間クエリ用\n  # rgeo-activerecord を使用\n\n  # バリデーション\n  validates :title, length: { maximum: 100 }, allow_nil: true\n  validates :description, length: { maximum: 500 }, allow_nil: true\n  validates :captured_at, presence: true\n\n  # Enum\n  enum :moderation_status, { pending: 0, approved: 1, hidden: 2, deleted: 3 }\n\n  # スコープ\n  scope :visible, -> { where(is_visible: true, moderation_status: :approved) }\n  scope :recent, -> { order(captured_at: :desc) }\n  scope :within_bounds, ->(sw_lat, sw_lng, ne_lat, ne_lng) {\n    where(\"ST_Within(location, ST_MakeEnvelope(?, ?, ?, ?, 4326))\", sw_lng, sw_lat, ne_lng, ne_lat)\n  }\n\n  # 属性\n  # id: uuid\n  # user_id: uuid (FK)\n  # title: string\n  # description: text\n  # location: geography(point, 4326)  # PostGIS\n  # altitude: decimal\n  # accuracy: decimal\n  # location_name: string\n  # captured_at: datetime\n  # like_count: integer (default: 0)\n  # comment_count: integer (default: 0)\n  # is_visible: boolean (default: true)\n  # moderation_status: integer (default: 1)\n  # created_at, updated_at\nend\n```\n\n### WeatherCondition（気象条件）\n```ruby\n# app/models/weather_condition.rb\nclass WeatherCondition < ApplicationRecord\n  belongs_to :photo\n  belongs_to :radar_datum, optional: true\n\n  # 属性\n  # id: uuid\n  # photo_id: uuid (FK)\n  # timestamp: datetime\n  # temperature: decimal (気温 ℃)\n  # humidity: decimal (湿度 %)\n  # pressure: decimal (気圧 hPa)\n  # weather_code: string\n  # weather_description: string\n  # wind_speed: decimal (風速 m/s)\n  # wind_direction: decimal (風向 度)\n  # wind_gust: decimal (突風 m/s)\n  # precipitation: decimal (降水量 mm)\n  # precipitation_type: string (rain/snow/none)\n  # cloud_cover: decimal (雲量 %)\n  # visibility: decimal (視程 km)\n  # sun_azimuth: decimal (太陽方位角 度)\n  # sun_altitude: decimal (太陽高度 度)\n  # radar_datum_id: uuid (FK)\n  # created_at\nend\n```\n\n### RadarDatum（雨雲レーダーデータ）\n```ruby\n# app/models/radar_datum.rb\nclass RadarDatum < ApplicationRecord\n  # Active Storage\n  has_one_attached :radar_image\n\n  # アソシエーション\n  belongs_to :photo\n  has_many :weather_conditions\n\n  # 属性\n  # id: uuid\n  # photo_id: uuid (FK)\n  # timestamp: datetime\n  # center_location: geography(point, 4326)\n  # radius: decimal (範囲半径 km)\n  # precipitation_intensity: decimal\n  # precipitation_area: jsonb (GeoJSON)\n  # movement_direction: decimal (移動方向 度)\n  # movement_speed: decimal (移動速度 km/h)\n  # created_at\nend\n```\n\n### Comment（コメント）\n```ruby\n# app/models/comment.rb\nclass Comment < ApplicationRecord\n  belongs_to :user\n  belongs_to :photo, counter_cache: true\n  has_many :reports, as: :reportable, dependent: :destroy\n\n  validates :content, presence: true, length: { maximum: 500 }\n\n  scope :visible, -> { where(is_visible: true) }\nend\n```\n\n### Like（いいね）\n```ruby\n# app/models/like.rb\nclass Like < ApplicationRecord\n  belongs_to :user\n  belongs_to :photo, counter_cache: true\n\n  validates :user_id, uniqueness: { scope: :photo_id }\nend\n```\n\n### Notification（通知）\n```ruby\n# app/models/notification.rb\nclass Notification < ApplicationRecord\n  belongs_to :user\n\n  enum :notification_type, { rainbow_alert: 0, like: 1, comment: 2, system: 3 }\n\n  scope :unread, -> { where(is_read: false) }\n  scope :recent, -> { order(created_at: :desc) }\nend\n```\n\n### Report（報告）\n```ruby\n# app/models/report.rb\nclass Report < ApplicationRecord\n  belongs_to :reporter, class_name: 'User'\n  belongs_to :reportable, polymorphic: true\n  belongs_to :resolved_by, class_name: 'User', optional: true\n\n  enum :status, { pending: 0, resolved: 1, dismissed: 2 }\nend\n```\n\n### データベーススキーマ（PostgreSQL + PostGIS）\n\n```ruby\n# db/migrate/xxxxx_create_tables.rb\n\n# PostGIS拡張の有効化\nenable_extension 'postgis'\nenable_extension 'pgcrypto'  # UUIDサポート\n\ncreate_table :users, id: :uuid do |t|\n  t.string :email, null: false\n  t.string :encrypted_password, null: false\n  t.string :display_name, null: false, limit: 30\n  t.integer :role, default: 0\n  t.jsonb :notification_settings, default: {}\n  t.string :locale, default: 'ja', limit: 5\n\n  # Devise\n  t.string :reset_password_token\n  t.datetime :reset_password_sent_at\n  t.datetime :remember_created_at\n  t.string :confirmation_token\n  t.datetime :confirmed_at\n  t.datetime :confirmation_sent_at\n  t.string :unconfirmed_email\n\n  t.timestamps\n  t.datetime :deleted_at\n\n  t.index :email, unique: true\n  t.index :reset_password_token, unique: true\n  t.index :confirmation_token, unique: true\nend\n\ncreate_table :photos, id: :uuid do |t|\n  t.references :user, type: :uuid, foreign_key: true, null: false\n  t.string :title, limit: 100\n  t.text :description\n  t.st_point :location, geographic: true, srid: 4326, null: false\n  t.decimal :altitude\n  t.decimal :accuracy\n  t.string :location_name\n  t.datetime :captured_at, null: false\n  t.integer :like_count, default: 0\n  t.integer :comment_count, default: 0\n  t.boolean :is_visible, default: true\n  t.integer :moderation_status, default: 1\n\n  t.timestamps\n\n  t.index :location, using: :gist\n  t.index :captured_at\n  t.index :user_id\nend\n\ncreate_table :weather_conditions, id: :uuid do |t|\n  t.references :photo, type: :uuid, foreign_key: true, null: false\n  t.datetime :timestamp, null: false\n  t.decimal :temperature\n  t.decimal :humidity\n  t.decimal :pressure\n  t.string :weather_code, limit: 20\n  t.string :weather_description\n  t.decimal :wind_speed\n  t.decimal :wind_direction\n  t.decimal :wind_gust\n  t.decimal :precipitation\n  t.string :precipitation_type, limit: 20\n  t.decimal :cloud_cover\n  t.decimal :visibility\n  t.decimal :sun_azimuth\n  t.decimal :sun_altitude\n  t.references :radar_datum, type: :uuid, foreign_key: true\n\n  t.datetime :created_at\n\n  t.index [:photo_id, :timestamp]\nend\n\n# radar_data, comments, likes, notifications, reports は同様に定義\n```\n\n## エラーハンドリング\n\n### Rails での統一エラーハンドリング\n\n```ruby\n# app/controllers/application_controller.rb\nclass ApplicationController < ActionController::API\n  rescue_from ActiveRecord::RecordNotFound, with: :not_found\n  rescue_from ActiveRecord::RecordInvalid, with: :unprocessable_entity\n  rescue_from ActionController::ParameterMissing, with: :bad_request\n  rescue_from Pundit::NotAuthorizedError, with: :forbidden\n\n  private\n\n  def not_found(exception)\n    render json: { error: { code: 3001, message: exception.message } }, status: :not_found\n  end\n\n  def unprocessable_entity(exception)\n    render json: { error: { code: 2001, message: exception.message, details: exception.record&.errors } }, status: :unprocessable_entity\n  end\n\n  def bad_request(exception)\n    render json: { error: { code: 2002, message: exception.message } }, status: :bad_request\n  end\n\n  def forbidden(exception)\n    render json: { error: { code: 1003, message: 'アクセス権限がありません' } }, status: :forbidden\n  end\nend\n```\n\n### エラーコード体系\n\n| コード範囲 | カテゴリ | 例 |\n|-----------|---------|-----|\n| 1000-1999 | 認証エラー | 1001: 無効なメール, 1002: パスワード不正, 1003: 権限不足 |\n| 2000-2999 | バリデーションエラー | 2001: 必須フィールド不足, 2002: 文字数超過 |\n| 3000-3999 | リソースエラー | 3001: 写真が見つからない, 3002: ユーザーが見つからない |\n| 4000-4999 | 外部サービスエラー | 4001: 気象API障害, 4002: S3アップロード失敗 |\n| 5000-5999 | サーバーエラー | 5001: データベースエラー, 5002: 内部エラー |\n\n### エラーシナリオ\n\n#### 1. ネットワークエラー\n- **説明**: API通信失敗、タイムアウト\n- **ハンドリング**: モバイルアプリで自動リトライ（exponential backoff）\n- **ユーザー影響**: 「接続エラー。再試行中...」トースト表示\n\n#### 2. 認証エラー\n- **説明**: トークン期限切れ、無効な認証情報\n- **ハンドリング**: Devise JWT でリフレッシュトークン自動更新\n- **ユーザー影響**: 「セッションが切れました。再度ログインしてください」\n\n#### 3. 画像アップロードエラー\n- **説明**: ファイルサイズ超過、サーバーエラー\n- **ハンドリング**: Active Storage のバリデーション、ImageProcessingJob でリトライ\n- **ユーザー影響**: 「アップロードに失敗しました。後で自動的に再試行します」\n\n#### 4. 気象API エラー\n- **説明**: 外部APIの障害、レート制限\n- **ハンドリング**: Solid Cache でキャッシュ使用、Solid Queue でリトライ\n- **ユーザー影響**: 「一部の気象データを取得できませんでした」\n\n## テスト戦略\n\n### ユニットテスト（RSpec）\n- **対象**: モデル、サービス、バリデータ\n- **フレームワーク**: RSpec + FactoryBot + Faker\n- **カバレッジ目標**: 80%以上（SimpleCov）\n- **重点テスト項目**:\n  - User モデル: Devise 認証、バリデーション\n  - Photo モデル: PostGIS クエリ、スコープ\n  - WeatherService: 気象データ解析、虹条件判定\n  - PhotoService: 画像処理、メタデータ抽出\n\n### リクエストスペック（統合テスト）\n- **対象**: API エンドポイント\n- **フレームワーク**: RSpec + rack-test\n- **重点テストフロー**:\n  - ユーザー登録 → メール認証 → ログイン\n  - 写真アップロード → 気象データ取得 → 保存\n  - いいね・コメント操作\n  - 通知設定変更\n\n### ジョブテスト\n- **対象**: Solid Queue ジョブ\n- **フレームワーク**: RSpec + ActiveJob::TestHelper\n- **重点テスト項目**:\n  - WeatherFetchJob: 外部API呼び出し、エラーハンドリング\n  - RainbowAlertJob: プッシュ通知送信\n  - ImageProcessingJob: サムネイル生成\n\n### E2Eテスト（モバイルアプリ）\n- **対象**: 主要ユーザーフロー\n- **フレームワーク**: Detox（React Native）\n- **テストシナリオ**:\n  1. 新規ユーザー登録からオンボーディング完了\n  2. 虹の写真撮影・アップロード・公開\n  3. フィード閲覧・フィルタリング・検索\n  4. マップビュー・ヒートマップ表示\n  5. 他ユーザーの写真へのいいね・コメント\n  6. プロフィール編集・写真削除\n  7. 通知設定変更\n\n### パフォーマンステスト\n- **ツール**: k6, Apache Bench\n- **テスト項目**:\n  - API応答時間（目標: p95 < 200ms）\n  - 画像アップロード時間（目標: < 10秒@10Mbps）\n  - 同時接続数（目標: 1000同時ユーザー）\n  - データベースクエリ性能（bullet gem でN+1検出）\n\n### セキュリティテスト\n- **ツール**: Brakeman, bundler-audit\n- **テスト項目**:\n  - SQLインジェクション\n  - XSS（クロスサイトスクリプティング）\n  - 認証・認可の不備\n  - 機密データの露出\n  - レート制限の動作確認（rack-attack）\n",
  "fileStats": {
    "size": 33752,
    "lines": 958,
    "lastModified": "2026-01-20T19:01:01.354Z"
  },
  "comments": []
}