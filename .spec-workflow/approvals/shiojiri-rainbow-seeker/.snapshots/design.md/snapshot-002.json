{
  "id": "snapshot_1768935490491_ltxixtzii",
  "approvalId": "approval_1768935396295_jvyj3iqt8",
  "approvalTitle": "塩尻レインボーシーカー 設計書",
  "version": 2,
  "timestamp": "2026-01-20T18:58:10.491Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# 設計書\n\n## 概要\n\n塩尻レインボーシーカー（ShiojiriRainbowSeeker）は、虹の写真共有、虹出現通知、および虹出現地域分析の3つの主要機能を提供するモバイルアプリケーションです。本設計書では、クロスプラットフォームモバイルアプリ（React Native）とバックエンドAPI（Node.js/Express）、およびデータベース（PostgreSQL/PostGIS）を用いたシステムアーキテクチャを定義します。\n\n### 設計の基本方針\n- **モジュラー設計**: 各機能を独立したモジュールとして実装し、保守性と拡張性を確保\n- **オフラインファースト**: ネットワーク接続がない状態でも基本的な操作を可能にする\n- **スケーラブル**: 将来のユーザー数増加や機能拡張に対応できる設計\n- **セキュアバイデザイン**: セキュリティを設計段階から組み込む\n\n## ステアリングドキュメントとの整合性\n\n### 技術標準（tech.md）\n本プロジェクトは新規開発のため、以下の技術スタックを採用します：\n- **フロントエンド**: React Native（iOS/Android対応）\n- **バックエンド**: Node.js + Express + TypeScript\n- **データベース**: PostgreSQL + PostGIS（地理空間データ対応）\n- **認証**: JWT（JSON Web Token）\n- **API設計**: RESTful API\n- **画像ストレージ**: AWS S3 + CloudFront CDN\n\n### プロジェクト構造（structure.md）\n```\nshiojiri-rainbow-seeker/\n├── mobile/                    # React Nativeモバイルアプリ\n│   ├── src/\n│   │   ├── components/        # 再利用可能なUIコンポーネント\n│   │   ├── screens/           # 画面コンポーネント\n│   │   ├── navigation/        # ナビゲーション設定\n│   │   ├── services/          # APIクライアント、外部サービス連携\n│   │   ├── hooks/             # カスタムフック\n│   │   ├── store/             # 状態管理（Redux/Zustand）\n│   │   ├── utils/             # ユーティリティ関数\n│   │   ├── types/             # TypeScript型定義\n│   │   ├── i18n/              # 国際化（日本語/英語）\n│   │   └── assets/            # 画像、フォント等\n│   └── __tests__/             # テストファイル\n├── backend/                   # Node.jsバックエンドAPI\n│   ├── src/\n│   │   ├── controllers/       # リクエストハンドラ\n│   │   ├── services/          # ビジネスロジック\n│   │   ├── models/            # データモデル（Prisma）\n│   │   ├── middleware/        # ミドルウェア\n│   │   ├── routes/            # APIルート定義\n│   │   ├── utils/             # ユーティリティ\n│   │   ├── types/             # TypeScript型定義\n│   │   └── jobs/              # バックグラウンドジョブ\n│   └── __tests__/             # テストファイル\n└── shared/                    # 共有型定義・定数\n```\n\n## コード再利用分析\n\n### 新規プロジェクトのため活用する外部ライブラリ\n\n#### モバイルアプリ（React Native）\n- **react-native-maps**: マップ表示、マーカー、クラスタリング\n- **react-native-camera / expo-camera**: カメラ機能\n- **react-native-image-picker**: 画像選択\n- **@react-native-community/geolocation**: GPS位置取得\n- **react-native-push-notification / expo-notifications**: プッシュ通知\n- **@react-navigation/native**: 画面遷移\n- **react-native-chart-kit**: グラフ表示（気象データ可視化）\n- **i18next / react-i18next**: 多言語対応\n- **zustand / redux-toolkit**: 状態管理\n- **react-query / tanstack-query**: サーバー状態管理\n- **async-storage**: ローカルストレージ\n\n#### バックエンド（Node.js）\n- **prisma**: ORM（PostgreSQL対応）\n- **express**: Webフレームワーク\n- **bcrypt**: パスワードハッシュ\n- **jsonwebtoken**: JWT認証\n- **multer / multer-s3**: ファイルアップロード\n- **sharp**: 画像圧縮・リサイズ\n- **node-cron**: スケジュールジョブ\n- **winston**: ロギング\n- **joi / zod**: バリデーション\n- **suncalc**: 太陽位置計算\n- **firebase-admin**: FCMプッシュ通知\n\n### 統合ポイント\n\n| 外部サービス | 用途 | 統合方法 |\n|-------------|------|----------|\n| OpenWeatherMap API | 気象データ取得 | REST API呼び出し |\n| 気象庁API / RainViewer | 雨雲レーダーデータ | REST API呼び出し |\n| AWS S3 | 画像ストレージ | AWS SDK |\n| CloudFront CDN | 画像配信 | S3連携 |\n| Firebase Cloud Messaging | Androidプッシュ通知 | firebase-admin SDK |\n| Apple Push Notification | iOSプッシュ通知 | apn ライブラリ |\n| SendGrid | メール送信 | SendGrid SDK |\n| Google Maps / Mapbox | 地図表示・ジオコーディング | React Native SDK |\n\n## アーキテクチャ\n\n### システム全体アーキテクチャ\n\n```mermaid\ngraph TB\n    subgraph \"モバイルアプリ（React Native）\"\n        MA[メインアプリ]\n        MA --> AUTH_S[認証画面]\n        MA --> FEED_S[フィード画面]\n        MA --> MAP_S[マップ画面]\n        MA --> CAMERA_S[カメラ画面]\n        MA --> PROFILE_S[プロフィール画面]\n        MA --> SETTINGS_S[設定画面]\n    end\n\n    subgraph \"バックエンドAPI（Node.js/Express）\"\n        API[API Gateway]\n        API --> AUTH_C[認証コントローラ]\n        API --> PHOTO_C[写真コントローラ]\n        API --> USER_C[ユーザーコントローラ]\n        API --> NOTIF_C[通知コントローラ]\n        API --> WEATHER_C[気象コントローラ]\n        API --> SOCIAL_C[ソーシャルコントローラ]\n    end\n\n    subgraph \"サービス層\"\n        AUTH_SVC[認証サービス]\n        PHOTO_SVC[写真サービス]\n        WEATHER_SVC[気象サービス]\n        NOTIF_SVC[通知サービス]\n        ANALYSIS_SVC[分析サービス]\n    end\n\n    subgraph \"データ層\"\n        DB[(PostgreSQL + PostGIS)]\n        CACHE[(Redis Cache)]\n        S3[(AWS S3)]\n    end\n\n    subgraph \"外部サービス\"\n        WEATHER_API[気象API]\n        RADAR_API[雨雲レーダーAPI]\n        FCM[Firebase Cloud Messaging]\n        APNS[Apple Push Notification]\n        EMAIL[SendGrid]\n    end\n\n    MA <--> API\n    AUTH_C --> AUTH_SVC\n    PHOTO_C --> PHOTO_SVC\n    WEATHER_C --> WEATHER_SVC\n    NOTIF_C --> NOTIF_SVC\n\n    AUTH_SVC --> DB\n    PHOTO_SVC --> DB\n    PHOTO_SVC --> S3\n    WEATHER_SVC --> WEATHER_API\n    WEATHER_SVC --> RADAR_API\n    WEATHER_SVC --> CACHE\n    WEATHER_SVC --> DB\n    NOTIF_SVC --> FCM\n    NOTIF_SVC --> APNS\n    NOTIF_SVC --> EMAIL\n    ANALYSIS_SVC --> DB\n```\n\n### モジュラー設計原則\n\n- **単一ファイル責任**: 各ファイルは1つの明確な責務のみを持つ\n- **コンポーネント分離**: 小さく焦点を絞ったコンポーネントを作成\n- **サービス層分離**: データアクセス、ビジネスロジック、プレゼンテーション層を分離\n- **ユーティリティモジュール化**: 汎用機能は単一目的のモジュールに分割\n\n### データフロー\n\n```mermaid\nsequenceDiagram\n    participant User as ユーザー\n    participant App as モバイルアプリ\n    participant API as バックエンドAPI\n    participant DB as PostgreSQL\n    participant S3 as AWS S3\n    participant Weather as 気象API\n\n    Note over User, Weather: 虹の写真アップロードフロー\n    User->>App: 写真撮影/選択\n    App->>App: GPS位置取得\n    App->>App: 画像圧縮\n    App->>API: POST /api/photos\n    API->>S3: 画像アップロード\n    S3-->>API: 画像URL\n    API->>Weather: 気象データ取得（前後3時間）\n    Weather-->>API: 気象条件データ\n    API->>DB: 写真・気象データ保存\n    DB-->>API: 保存完了\n    API-->>App: 成功レスポンス\n    App-->>User: アップロード完了通知\n```\n\n## コンポーネントとインターフェース\n\n### モバイルアプリ コンポーネント\n\n#### 画面コンポーネント\n\n##### AuthScreen（認証画面）\n- **目的**: ユーザーのログイン・登録・パスワードリセット\n- **インターフェース**:\n  - `login(email, password): Promise<User>`\n  - `register(email, password, displayName): Promise<User>`\n  - `resetPassword(email): Promise<void>`\n- **依存**: AuthService, ValidationUtils\n- **要件参照**: FR-1\n\n##### FeedScreen（フィード画面）\n- **目的**: 虹の写真フィードの表示、フィルタリング、検索\n- **インターフェース**:\n  - `fetchPhotos(page, filters): Promise<Photo[]>`\n  - `filterByLocation(lat, lng, radius): void`\n  - `filterByDateRange(start, end): void`\n  - `searchByKeyword(keyword): void`\n- **依存**: PhotoService, LocationService\n- **要件参照**: FR-4\n\n##### MapScreen（マップ画面）\n- **目的**: 地図上に虹の目撃情報を表示、ヒートマップ\n- **インターフェース**:\n  - `loadMarkers(bounds): Promise<Marker[]>`\n  - `showHeatmap(): void`\n  - `showRegionStats(regionId): Promise<RegionStats>`\n- **依存**: MapService, AnalysisService\n- **要件参照**: FR-5, FR-13\n\n##### CameraScreen（カメラ画面）\n- **目的**: 虹の写真撮影、ギャラリー選択、位置タグ付け\n- **インターフェース**:\n  - `capturePhoto(): Promise<PhotoData>`\n  - `selectFromGallery(): Promise<PhotoData>`\n  - `setLocation(lat, lng): void`\n  - `uploadPhoto(photoData, metadata): Promise<Photo>`\n- **依存**: CameraService, LocationService, PhotoService\n- **要件参照**: FR-2, FR-3\n\n##### PhotoDetailScreen（写真詳細画面）\n- **目的**: 写真の詳細表示、気象条件データ、コメント\n- **インターフェース**:\n  - `getPhotoDetail(photoId): Promise<PhotoDetail>`\n  - `getWeatherData(photoId): Promise<WeatherData>`\n  - `likePhoto(photoId): Promise<void>`\n  - `addComment(photoId, content): Promise<Comment>`\n- **依存**: PhotoService, WeatherService, SocialService\n- **要件参照**: FR-3, FR-8, FR-13\n\n##### ProfileScreen（プロフィール画面）\n- **目的**: ユーザープロフィール管理、自分の写真一覧\n- **インターフェース**:\n  - `getUserProfile(): Promise<UserProfile>`\n  - `updateProfile(data): Promise<UserProfile>`\n  - `getMyPhotos(page): Promise<Photo[]>`\n  - `deletePhoto(photoId): Promise<void>`\n- **依存**: UserService, PhotoService\n- **要件参照**: FR-9\n\n##### SettingsScreen（設定画面）\n- **目的**: 通知設定、プライバシー設定、アカウント管理\n- **インターフェース**:\n  - `getSettings(): Promise<Settings>`\n  - `updateNotificationSettings(settings): Promise<void>`\n  - `exportData(): Promise<string>`\n  - `deleteAccount(): Promise<void>`\n- **依存**: SettingsService, NotificationService\n- **要件参照**: FR-7, FR-12\n\n#### 共通UIコンポーネント\n\n| コンポーネント | 目的 | Props |\n|---------------|------|-------|\n| PhotoCard | 写真カードの表示 | photo, onPress, onLike |\n| PhotoGrid | 写真のグリッド表示 | photos, columns, onPhotoPress |\n| MapMarker | マップマーカー | location, count, onPress |\n| ClusteredMap | クラスタリング地図 | markers, onMarkerPress |\n| WeatherChart | 気象データグラフ | weatherData, timeRange |\n| RadarAnimation | 雨雲レーダーアニメーション | radarData, timestamps |\n| CommentList | コメント一覧 | comments, onReply |\n| LocationPicker | 位置選択マップ | initialLocation, onSelect |\n| LoadingSpinner | ローディング表示 | size, color |\n| ErrorBoundary | エラー境界 | fallback, onError |\n\n### バックエンドAPI コンポーネント\n\n#### コントローラー\n\n##### AuthController\n- **目的**: 認証エンドポイント処理\n- **エンドポイント**:\n  - `POST /api/auth/register` - ユーザー登録\n  - `POST /api/auth/login` - ログイン\n  - `POST /api/auth/logout` - ログアウト\n  - `POST /api/auth/refresh` - トークンリフレッシュ\n  - `POST /api/auth/password-reset` - パスワードリセット要求\n  - `POST /api/auth/password-reset/confirm` - パスワードリセット確認\n  - `GET /api/auth/verify-email/:token` - メール認証\n- **要件参照**: FR-1\n\n##### PhotoController\n- **目的**: 写真関連エンドポイント処理\n- **エンドポイント**:\n  - `GET /api/photos` - 写真一覧取得（ページネーション、フィルタ対応）\n  - `GET /api/photos/:id` - 写真詳細取得\n  - `POST /api/photos` - 写真アップロード\n  - `PUT /api/photos/:id` - 写真情報更新\n  - `DELETE /api/photos/:id` - 写真削除\n  - `GET /api/photos/:id/weather` - 気象条件データ取得\n- **要件参照**: FR-2, FR-3, FR-4, FR-13\n\n##### MapController\n- **目的**: 地図関連エンドポイント処理\n- **エンドポイント**:\n  - `GET /api/map/markers` - 範囲内のマーカー取得\n  - `GET /api/map/clusters` - クラスタリングされたマーカー取得\n  - `GET /api/map/heatmap` - ヒートマップデータ取得\n  - `GET /api/map/regions/:id/stats` - 地域統計取得\n- **要件参照**: FR-5, FR-13\n\n##### SocialController\n- **目的**: ソーシャル機能エンドポイント処理\n- **エンドポイント**:\n  - `POST /api/photos/:id/like` - いいね\n  - `DELETE /api/photos/:id/like` - いいね解除\n  - `GET /api/photos/:id/comments` - コメント一覧\n  - `POST /api/photos/:id/comments` - コメント投稿\n  - `POST /api/photos/:id/report` - 不適切コンテンツ報告\n- **要件参照**: FR-8\n\n##### NotificationController\n- **目的**: 通知関連エンドポイント処理\n- **エンドポイント**:\n  - `GET /api/notifications` - 通知一覧\n  - `PUT /api/notifications/:id/read` - 既読マーク\n  - `GET /api/notifications/settings` - 通知設定取得\n  - `PUT /api/notifications/settings` - 通知設定更新\n- **要件参照**: FR-6, FR-7\n\n##### UserController\n- **目的**: ユーザー関連エンドポイント処理\n- **エンドポイント**:\n  - `GET /api/users/me` - 自分のプロフィール取得\n  - `PUT /api/users/me` - プロフィール更新\n  - `GET /api/users/me/photos` - 自分の写真一覧\n  - `POST /api/users/me/export` - データエクスポート要求\n  - `DELETE /api/users/me` - アカウント削除\n- **要件参照**: FR-9, FR-12\n\n##### AdminController\n- **目的**: 管理者機能エンドポイント処理\n- **エンドポイント**:\n  - `GET /api/admin/reports` - 報告一覧\n  - `PUT /api/admin/reports/:id` - 報告処理（承認/非表示/削除）\n  - `GET /api/admin/users` - ユーザー一覧\n  - `PUT /api/admin/users/:id/status` - ユーザーステータス変更\n- **要件参照**: FR-10\n\n#### サービス層\n\n##### AuthService\n```typescript\ninterface AuthService {\n  register(email: string, password: string, displayName: string): Promise<User>;\n  login(email: string, password: string): Promise<AuthTokens>;\n  verifyEmail(token: string): Promise<void>;\n  refreshToken(refreshToken: string): Promise<AuthTokens>;\n  resetPassword(email: string): Promise<void>;\n  confirmPasswordReset(token: string, newPassword: string): Promise<void>;\n}\n```\n\n##### PhotoService\n```typescript\ninterface PhotoService {\n  create(userId: string, file: Buffer, metadata: PhotoMetadata): Promise<Photo>;\n  getById(photoId: string): Promise<PhotoWithDetails>;\n  getList(filters: PhotoFilters, pagination: Pagination): Promise<PaginatedPhotos>;\n  update(photoId: string, data: PhotoUpdateData): Promise<Photo>;\n  delete(photoId: string): Promise<void>;\n  getWeatherData(photoId: string): Promise<WeatherConditionData>;\n}\n```\n\n##### WeatherService\n```typescript\ninterface WeatherService {\n  fetchCurrentConditions(lat: number, lng: number): Promise<WeatherData>;\n  fetchHistoricalData(lat: number, lng: number, startTime: Date, endTime: Date): Promise<WeatherData[]>;\n  fetchRadarData(lat: number, lng: number, timestamps: Date[]): Promise<RadarData[]>;\n  calculateSunPosition(lat: number, lng: number, time: Date): SunPosition;\n  checkRainbowConditions(lat: number, lng: number): Promise<RainbowCondition>;\n}\n```\n\n##### NotificationService\n```typescript\ninterface NotificationService {\n  sendPushNotification(userId: string, notification: NotificationPayload): Promise<void>;\n  sendRainbowAlert(userIds: string[], condition: RainbowCondition): Promise<void>;\n  scheduleNotification(notification: ScheduledNotification): Promise<void>;\n  getUserNotifications(userId: string, pagination: Pagination): Promise<Notification[]>;\n}\n```\n\n##### AnalysisService\n```typescript\ninterface AnalysisService {\n  getRegionStats(regionId: string): Promise<RegionStatistics>;\n  getHeatmapData(bounds: GeoBounds): Promise<HeatmapData>;\n  getRainbowTrends(regionId: string): Promise<RainbowTrends>;\n  exportDataset(filters: DatasetFilters): Promise<string>;\n}\n```\n\n## データモデル\n\n### User（ユーザー）\n```typescript\ninterface User {\n  id: string;                    // UUID\n  email: string;                 // メールアドレス（ユニーク）\n  passwordHash: string;          // bcryptハッシュ\n  displayName: string;           // 表示名（3-30文字）\n  profileImageUrl: string | null; // プロフィール画像URL\n  role: 'user' | 'admin';        // ユーザーロール\n  emailVerified: boolean;        // メール認証済みフラグ\n  notificationSettings: NotificationSettings; // 通知設定（JSON）\n  locale: 'ja' | 'en';           // 言語設定\n  createdAt: Date;\n  updatedAt: Date;\n  deletedAt: Date | null;        // 論理削除\n}\n```\n\n### Photo（写真）\n```typescript\ninterface Photo {\n  id: string;                    // UUID\n  userId: string;                // 投稿ユーザーID\n  imageUrl: string;              // S3画像URL\n  thumbnailUrl: string;          // サムネイルURL\n  title: string | null;          // タイトル（最大100文字）\n  description: string | null;    // 説明（最大500文字）\n  location: {\n    latitude: number;            // 緯度\n    longitude: number;           // 経度\n    altitude: number | null;     // 高度\n    accuracy: number | null;     // 精度（メートル）\n  };\n  locationName: string | null;   // 逆ジオコーディングされた地名\n  capturedAt: Date;              // 撮影日時\n  likeCount: number;             // いいね数\n  commentCount: number;          // コメント数\n  isVisible: boolean;            // 公開フラグ\n  moderationStatus: 'pending' | 'approved' | 'hidden' | 'deleted';\n  createdAt: Date;\n  updatedAt: Date;\n}\n```\n\n### WeatherCondition（気象条件）\n```typescript\ninterface WeatherCondition {\n  id: string;                    // UUID\n  photoId: string;               // 関連写真ID\n  timestamp: Date;               // 気象データの時刻\n\n  // 基本気象データ\n  temperature: number | null;    // 気温（℃）\n  humidity: number | null;       // 湿度（%）\n  pressure: number | null;       // 気圧（hPa）\n  weatherCode: string | null;    // 天候コード\n  weatherDescription: string | null; // 天候説明\n\n  // 風データ\n  windSpeed: number | null;      // 風速（m/s）\n  windDirection: number | null;  // 風向（度）\n  windGust: number | null;       // 突風（m/s）\n\n  // 降水データ\n  precipitation: number | null;  // 降水量（mm）\n  precipitationType: 'rain' | 'snow' | 'none' | null;\n\n  // 雲・視程\n  cloudCover: number | null;     // 雲量（%）\n  visibility: number | null;     // 視程（km）\n\n  // 太陽位置\n  sunAzimuth: number | null;     // 太陽方位角（度）\n  sunAltitude: number | null;    // 太陽高度（度）\n\n  // レーダーデータ参照\n  radarDataId: string | null;    // 雨雲レーダーデータID\n\n  createdAt: Date;\n}\n```\n\n### RadarData（雨雲レーダーデータ）\n```typescript\ninterface RadarData {\n  id: string;                    // UUID\n  photoId: string;               // 関連写真ID\n  timestamp: Date;               // レーダーデータの時刻\n  centerLat: number;             // 中心緯度\n  centerLng: number;             // 中心経度\n  radius: number;                // 範囲半径（km）\n  precipitationIntensity: number | null; // 降水強度\n  precipitationArea: GeoJSON | null;     // 降水エリア（GeoJSON）\n  movementDirection: number | null;      // 移動方向（度）\n  movementSpeed: number | null;          // 移動速度（km/h）\n  imageUrl: string | null;       // レーダー画像URL\n  createdAt: Date;\n}\n```\n\n### Comment（コメント）\n```typescript\ninterface Comment {\n  id: string;                    // UUID\n  photoId: string;               // 対象写真ID\n  userId: string;                // 投稿ユーザーID\n  content: string;               // コメント内容（最大500文字）\n  isVisible: boolean;            // 表示フラグ\n  createdAt: Date;\n  updatedAt: Date;\n}\n```\n\n### Like（いいね）\n```typescript\ninterface Like {\n  id: string;                    // UUID\n  photoId: string;               // 対象写真ID\n  userId: string;                // ユーザーID\n  createdAt: Date;\n}\n// 複合ユニーク制約: (photoId, userId)\n```\n\n### Notification（通知）\n```typescript\ninterface Notification {\n  id: string;                    // UUID\n  userId: string;                // 受信ユーザーID\n  type: 'rainbow_alert' | 'like' | 'comment' | 'system';\n  title: string;                 // 通知タイトル\n  body: string;                  // 通知本文\n  data: Record<string, any>;     // 追加データ（JSON）\n  isRead: boolean;               // 既読フラグ\n  createdAt: Date;\n}\n```\n\n### Report（報告）\n```typescript\ninterface Report {\n  id: string;                    // UUID\n  reporterId: string;            // 報告者ID\n  targetType: 'photo' | 'comment';\n  targetId: string;              // 対象ID\n  reason: string;                // 報告理由\n  status: 'pending' | 'resolved' | 'dismissed';\n  resolution: string | null;     // 対応内容\n  resolvedBy: string | null;     // 対応管理者ID\n  resolvedAt: Date | null;\n  createdAt: Date;\n}\n```\n\n### NotificationSettings（通知設定）\n```typescript\ninterface NotificationSettings {\n  rainbowAlerts: boolean;        // 虹アラート有効\n  socialNotifications: boolean;  // いいね・コメント通知\n  locationRadius: number;        // 通知対象半径（km）\n  quietHoursStart: string | null; // 静寂時間開始（HH:mm）\n  quietHoursEnd: string | null;   // 静寂時間終了（HH:mm）\n  notificationLocation: {\n    type: 'current' | 'fixed';\n    latitude: number | null;\n    longitude: number | null;\n  };\n}\n```\n\n### データベーススキーマ（PostgreSQL + PostGIS）\n\n```sql\n-- PostGIS拡張の有効化\nCREATE EXTENSION IF NOT EXISTS postgis;\n\n-- ユーザーテーブル\nCREATE TABLE users (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    email VARCHAR(255) UNIQUE NOT NULL,\n    password_hash VARCHAR(255) NOT NULL,\n    display_name VARCHAR(30) NOT NULL,\n    profile_image_url TEXT,\n    role VARCHAR(20) DEFAULT 'user',\n    email_verified BOOLEAN DEFAULT FALSE,\n    notification_settings JSONB DEFAULT '{}',\n    locale VARCHAR(5) DEFAULT 'ja',\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    deleted_at TIMESTAMP WITH TIME ZONE\n);\n\n-- 写真テーブル\nCREATE TABLE photos (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id) ON DELETE CASCADE,\n    image_url TEXT NOT NULL,\n    thumbnail_url TEXT NOT NULL,\n    title VARCHAR(100),\n    description VARCHAR(500),\n    location GEOGRAPHY(POINT, 4326) NOT NULL,\n    altitude DECIMAL,\n    accuracy DECIMAL,\n    location_name TEXT,\n    captured_at TIMESTAMP WITH TIME ZONE NOT NULL,\n    like_count INTEGER DEFAULT 0,\n    comment_count INTEGER DEFAULT 0,\n    is_visible BOOLEAN DEFAULT TRUE,\n    moderation_status VARCHAR(20) DEFAULT 'approved',\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- 地理空間インデックス\nCREATE INDEX idx_photos_location ON photos USING GIST(location);\nCREATE INDEX idx_photos_captured_at ON photos(captured_at DESC);\nCREATE INDEX idx_photos_user_id ON photos(user_id);\n\n-- 気象条件テーブル\nCREATE TABLE weather_conditions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    photo_id UUID REFERENCES photos(id) ON DELETE CASCADE,\n    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,\n    temperature DECIMAL,\n    humidity DECIMAL,\n    pressure DECIMAL,\n    weather_code VARCHAR(20),\n    weather_description TEXT,\n    wind_speed DECIMAL,\n    wind_direction DECIMAL,\n    wind_gust DECIMAL,\n    precipitation DECIMAL,\n    precipitation_type VARCHAR(20),\n    cloud_cover DECIMAL,\n    visibility DECIMAL,\n    sun_azimuth DECIMAL,\n    sun_altitude DECIMAL,\n    radar_data_id UUID,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\nCREATE INDEX idx_weather_photo_id ON weather_conditions(photo_id);\nCREATE INDEX idx_weather_timestamp ON weather_conditions(timestamp);\n\n-- 雨雲レーダーデータテーブル\nCREATE TABLE radar_data (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    photo_id UUID REFERENCES photos(id) ON DELETE CASCADE,\n    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,\n    center_location GEOGRAPHY(POINT, 4326) NOT NULL,\n    radius DECIMAL NOT NULL,\n    precipitation_intensity DECIMAL,\n    precipitation_area JSONB,\n    movement_direction DECIMAL,\n    movement_speed DECIMAL,\n    image_url TEXT,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- その他のテーブル（comments, likes, notifications, reports）は同様に定義\n```\n\n## エラーハンドリング\n\n### エラーシナリオ\n\n#### 1. ネットワークエラー\n- **説明**: API通信失敗、タイムアウト\n- **ハンドリング**:\n  - 自動リトライ（exponential backoff）\n  - オフラインキューへの追加\n  - ローカルキャッシュからの表示\n- **ユーザー影響**: 「接続エラー。再試行中...」トースト表示\n\n#### 2. 認証エラー\n- **説明**: トークン期限切れ、無効な認証情報\n- **ハンドリング**:\n  - リフレッシュトークンによる自動更新\n  - 失敗時はログイン画面へリダイレクト\n- **ユーザー影響**: 「セッションが切れました。再度ログインしてください」\n\n#### 3. 画像アップロードエラー\n- **説明**: ファイルサイズ超過、サーバーエラー\n- **ハンドリング**:\n  - ファイルサイズチェック（クライアント側）\n  - 圧縮リトライ\n  - アップロードキューへの保存\n- **ユーザー影響**: 「アップロードに失敗しました。後で自動的に再試行します」\n\n#### 4. GPS取得エラー\n- **説明**: 位置情報サービス無効、精度不足\n- **ハンドリング**:\n  - 権限要求ダイアログ表示\n  - 手動位置選択UIの提供\n- **ユーザー影響**: 「位置情報を取得できません。地図から選択してください」\n\n#### 5. 気象API エラー\n- **説明**: 外部APIの障害、レート制限\n- **ハンドリング**:\n  - キャッシュデータの使用\n  - 取得可能なデータのみ保存\n  - バックグラウンドで再取得\n- **ユーザー影響**: 「一部の気象データを取得できませんでした」\n\n#### 6. プッシュ通知エラー\n- **説明**: FCM/APNs送信失敗\n- **ハンドリング**:\n  - リトライキューへの追加\n  - 失敗した通知のログ記録\n  - デバイストークンの更新確認\n- **ユーザー影響**: （バックグラウンド処理のため直接影響なし）\n\n### エラーコード体系\n\n| コード範囲 | カテゴリ | 例 |\n|-----------|---------|-----|\n| 1000-1999 | 認証エラー | 1001: 無効なメール, 1002: パスワード不正 |\n| 2000-2999 | バリデーションエラー | 2001: 必須フィールド不足, 2002: 文字数超過 |\n| 3000-3999 | リソースエラー | 3001: 写真が見つからない, 3002: ユーザーが見つからない |\n| 4000-4999 | 外部サービスエラー | 4001: 気象API障害, 4002: S3アップロード失敗 |\n| 5000-5999 | サーバーエラー | 5001: データベースエラー, 5002: 内部エラー |\n\n## テスト戦略\n\n### ユニットテスト\n- **対象**: サービス層、ユーティリティ関数、カスタムフック\n- **フレームワーク**: Jest + React Native Testing Library\n- **カバレッジ目標**: 80%以上\n- **重点テスト項目**:\n  - AuthService: 認証ロジック、トークン管理\n  - PhotoService: 画像処理、メタデータ抽出\n  - WeatherService: 気象データ解析、虹条件判定\n  - バリデーション関数\n  - 日付・位置計算ユーティリティ\n\n### 統合テスト\n- **対象**: APIエンドポイント、データベース操作\n- **フレームワーク**: Jest + Supertest\n- **テスト環境**: テスト用PostgreSQLコンテナ\n- **重点テストフロー**:\n  - ユーザー登録 → メール認証 → ログイン\n  - 写真アップロード → 気象データ取得 → 保存\n  - いいね・コメント操作\n  - 通知設定変更\n\n### E2Eテスト\n- **対象**: 主要ユーザーフロー\n- **フレームワーク**: Detox（React Native）\n- **テストシナリオ**:\n  1. 新規ユーザー登録からオンボーディング完了\n  2. 虹の写真撮影・アップロード・公開\n  3. フィード閲覧・フィルタリング・検索\n  4. マップビュー・ヒートマップ表示\n  5. 他ユーザーの写真へのいいね・コメント\n  6. プロフィール編集・写真削除\n  7. 通知設定変更\n\n### パフォーマンステスト\n- **ツール**: k6, Artillery\n- **テスト項目**:\n  - API応答時間（目標: p95 < 200ms）\n  - 画像アップロード時間（目標: < 10秒@10Mbps）\n  - 同時接続数（目標: 1000同時ユーザー）\n  - データベースクエリ性能\n\n### セキュリティテスト\n- **ツール**: OWASP ZAP, npm audit\n- **テスト項目**:\n  - SQLインジェクション\n  - XSS（クロスサイトスクリプティング）\n  - 認証・認可の不備\n  - 機密データの露出\n  - レート制限の動作確認\n",
  "fileStats": {
    "size": 30536,
    "lines": 792,
    "lastModified": "2026-01-20T18:56:29.968Z"
  },
  "comments": []
}