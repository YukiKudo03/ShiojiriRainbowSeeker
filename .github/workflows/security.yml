# Security Scanning Workflow
# ========================
# This workflow runs security scans on the backend codebase to identify
# vulnerabilities in code and dependencies.
#
# Runs on:
# - Push to main/develop branches
# - Pull requests to main/develop
# - Daily schedule (for new vulnerability discoveries)
# - Manual trigger

name: Security Scan

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/security.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/security.yml'
  schedule:
    # Run daily at 2:00 AM UTC to catch newly discovered vulnerabilities
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      full_scan:
        description: 'Run full security scan with verbose output'
        required: false
        default: 'false'
        type: boolean

env:
  RUBY_VERSION: '3.3'

jobs:
  # ==========================================================================
  # Brakeman Static Analysis
  # ==========================================================================
  brakeman:
    name: Brakeman Static Analysis
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: backend

      - name: Run Brakeman
        run: |
          bundle exec brakeman \
            --no-pager \
            --format json \
            --output tmp/brakeman_report.json \
            --exit-on-warn \
            --exit-on-error \
            -w2

      - name: Upload Brakeman Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brakeman-report
          path: backend/tmp/brakeman_report.json
          retention-days: 30

      - name: Generate HTML Report (on failure)
        if: failure()
        run: |
          bundle exec brakeman \
            --no-pager \
            --format html \
            --output tmp/brakeman_report.html

      - name: Upload HTML Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: brakeman-report-html
          path: backend/tmp/brakeman_report.html
          retention-days: 30

  # ==========================================================================
  # Bundler Audit - Dependency Vulnerability Check
  # ==========================================================================
  bundler-audit:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: backend

      - name: Update vulnerability database
        run: bundle exec bundler-audit update

      - name: Run bundler-audit
        run: bundle exec bundler-audit check --format json > tmp/bundler_audit_report.json

      - name: Upload Audit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundler-audit-report
          path: backend/tmp/bundler_audit_report.json
          retention-days: 30

  # ==========================================================================
  # Ruby Gems Security Check
  # ==========================================================================
  gem-check:
    name: Gem Security Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: backend

      - name: Check for outdated gems with security patches
        run: |
          echo "Checking for outdated gems..."
          bundle outdated --strict || true

      - name: Verify Gemfile.lock integrity
        run: |
          echo "Verifying Gemfile.lock integrity..."
          bundle check

  # ==========================================================================
  # Security Summary
  # ==========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [brakeman, bundler-audit, gem-check]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Generate Summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check Brakeman status
          if [ "${{ needs.brakeman.result }}" == "success" ]; then
            echo "| Brakeman | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Brakeman | :x: Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check bundler-audit status
          if [ "${{ needs.bundler-audit.result }}" == "success" ]; then
            echo "| Bundler-Audit | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Bundler-Audit | :x: Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check gem-check status
          if [ "${{ needs.gem-check.result }}" == "success" ]; then
            echo "| Gem Check | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Gem Check | :x: Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports are available as artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Fail if any check failed
        if: |
          needs.brakeman.result != 'success' ||
          needs.bundler-audit.result != 'success'
        run: |
          echo "Security checks failed. Please review the reports."
          exit 1

  # ==========================================================================
  # OWASP ZAP Scan (for deployed environments)
  # ==========================================================================
  # Note: This job is disabled by default. Enable it when you have a staging
  # environment to scan. OWASP ZAP performs dynamic analysis on running applications.
  #
  # owasp-zap:
  #   name: OWASP ZAP Dynamic Scan
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'schedule' || github.event.inputs.full_scan == 'true'
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: OWASP ZAP Baseline Scan
  #       uses: zaproxy/action-baseline@v0.12.0
  #       with:
  #         target: 'https://staging.your-app.com/api'
  #         rules_file_name: '.zap/rules.tsv'
  #         cmd_options: '-a'
  #
  #     - name: Upload ZAP Report
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: zap-report
  #         path: report_html.html

  # ==========================================================================
  # Notification (optional)
  # ==========================================================================
  # Uncomment to enable Slack notifications on security failures
  #
  # notify:
  #   name: Notify on Failure
  #   runs-on: ubuntu-latest
  #   needs: [security-summary]
  #   if: failure() && github.event_name == 'schedule'
  #
  #   steps:
  #     - name: Send Slack notification
  #       uses: slackapi/slack-github-action@v1.25.0
  #       with:
  #         payload: |
  #           {
  #             "text": "Security scan failed for ${{ github.repository }}",
  #             "blocks": [
  #               {
  #                 "type": "section",
  #                 "text": {
  #                   "type": "mrkdwn",
  #                   "text": ":warning: *Security Scan Failed*\nRepository: ${{ github.repository }}\nBranch: ${{ github.ref }}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
  #                 }
  #               }
  #             ]
  #           }
  #       env:
  #         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
