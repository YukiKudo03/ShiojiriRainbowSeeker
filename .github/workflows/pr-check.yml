# PR Check Workflow
# ==================
# This workflow validates pull requests with essential checks.
# Runs on all pull requests and provides a consolidated status check.
#
# Task 57: CI/CD Pipeline Construction
# Requirements: All FR

name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # PR Validation
  # ==========================================================================
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          TITLE="${{ github.event.pull_request.title }}"

          # Check for conventional commit format (optional)
          if [[ ! "$TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|ci|perf|build)(\(.+\))?:\ .+ ]]; then
            echo "::warning::PR title doesn't follow conventional commit format"
            echo "Recommended format: type(scope): description"
            echo "Types: feat, fix, docs, style, refactor, test, chore, ci, perf, build"
          fi

      - name: Check for WIP
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          if [[ "$TITLE" =~ ^(WIP|wip|Wip):?\  ]]; then
            echo "::notice::This is a Work in Progress PR"
          fi

      - name: Check branch naming
        run: |
          BRANCH="${{ github.head_ref }}"
          if [[ ! "$BRANCH" =~ ^(feature|fix|hotfix|release|chore|docs)/[a-z0-9-]+$ ]]; then
            echo "::warning::Branch name doesn't follow convention: type/description"
          fi

  # ==========================================================================
  # Changed Files Detection
  # ==========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      mobile: ${{ steps.filter.outputs.mobile }}
      workflows: ${{ steps.filter.outputs.workflows }}
      docs: ${{ steps.filter.outputs.docs }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
            mobile:
              - 'mobile/**'
            workflows:
              - '.github/workflows/**'
            docs:
              - 'docs/**'
              - '*.md'

  # ==========================================================================
  # Backend Checks
  # ==========================================================================
  backend-check:
    name: Backend Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    defaults:
      run:
        working-directory: backend

    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: shiojiri_rainbow_seeker_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      RAILS_ENV: test
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
      DATABASE_HOST: localhost
      DATABASE_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: backend

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client libpq-dev

      - name: Lint
        run: bundle exec rubocop --format github

      - name: Setup database
        run: |
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: Run tests
        run: bundle exec rspec --format progress

      - name: Security scan
        run: |
          bundle exec brakeman --no-pager -q
          bundle exec bundler-audit check --update

  # ==========================================================================
  # Mobile Checks
  # ==========================================================================
  mobile-check:
    name: Mobile Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.mobile == 'true'
    defaults:
      run:
        working-directory: mobile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint || true

      - name: Type check
        run: npm run type-check || npx tsc --noEmit

      - name: Run tests
        run: npm test -- --passWithNoTests

  # ==========================================================================
  # PR Summary
  # ==========================================================================
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [validate, changes, backend-check, mobile-check]
    if: always()

    steps:
      - name: Generate PR Summary
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            let body = `## PR Check Summary\n\n`;
            body += `| Check | Status |\n`;
            body += `|-------|--------|\n`;

            const backendCheck = '${{ needs.backend-check.result }}';
            const mobileCheck = '${{ needs.mobile-check.result }}';
            const backendChanged = '${{ needs.changes.outputs.backend }}' === 'true';
            const mobileChanged = '${{ needs.changes.outputs.mobile }}' === 'true';

            if (backendChanged) {
              const status = backendCheck === 'success' ? ':white_check_mark:' :
                             backendCheck === 'skipped' ? ':fast_forward:' : ':x:';
              body += `| Backend | ${status} ${backendCheck} |\n`;
            }

            if (mobileChanged) {
              const status = mobileCheck === 'success' ? ':white_check_mark:' :
                             mobileCheck === 'skipped' ? ':fast_forward:' : ':x:';
              body += `| Mobile | ${status} ${mobileCheck} |\n`;
            }

            if (!backendChanged && !mobileChanged) {
              body += `| No code changes | :information_source: |\n`;
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('PR Check Summary')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ==========================================================================
  # Required Status Check
  # ==========================================================================
  required-check:
    name: Required Status Check
    runs-on: ubuntu-latest
    needs: [backend-check, mobile-check]
    if: always()

    steps:
      - name: Check results
        run: |
          BACKEND_RESULT="${{ needs.backend-check.result }}"
          MOBILE_RESULT="${{ needs.mobile-check.result }}"

          # Success if all passed or were skipped
          if [[ "$BACKEND_RESULT" == "success" || "$BACKEND_RESULT" == "skipped" ]] && \
             [[ "$MOBILE_RESULT" == "success" || "$MOBILE_RESULT" == "skipped" ]]; then
            echo "All checks passed!"
            exit 0
          fi

          echo "Some checks failed"
          exit 1
