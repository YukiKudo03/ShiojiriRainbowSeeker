# =============================================================================
# Shiojiri Rainbow Seeker Backend - Docker Compose (Production Reference)
# =============================================================================
# Production deployment reference configuration
#
# NOTE: This is a reference configuration. For production deployment, consider:
#   - Using Kamal (included in Rails 8) for zero-downtime deployments
#   - Using managed database services (AWS RDS, GCP Cloud SQL, etc.)
#   - Using container orchestration (ECS, GKE, Kubernetes)
#
# Usage:
#   docker compose -f docker-compose.prod.yml up -d
#   docker compose -f docker-compose.prod.yml logs -f
#   docker compose -f docker-compose.prod.yml down
# =============================================================================

name: shiojiri-rainbow-seeker-prod

services:
  # ===========================================================================
  # PostgreSQL with PostGIS (Production)
  # ===========================================================================
  # NOTE: For production, prefer managed database services for:
  #   - Automated backups
  #   - High availability
  #   - Automatic failover
  #   - Security patches
  # ===========================================================================
  db:
    image: postgis/postgis:16-3.4-alpine
    container_name: shiojiri-rainbow-db-prod
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: shiojiri_rainbow_seeker_production
      POSTGRES_MULTIPLE_DATABASES: >-
        shiojiri_rainbow_seeker_production_cache,
        shiojiri_rainbow_seeker_production_queue,
        shiojiri_rainbow_seeker_production_cable
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.sh:ro
    # In production, typically DO NOT expose database port externally
    # ports:
    #   - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d shiojiri_rainbow_seeker_production"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ===========================================================================
  # Rails API (Production)
  # ===========================================================================
  api:
    image: ${DOCKER_REGISTRY:-}shiojiri-rainbow-backend:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: shiojiri-rainbow-api-prod
    restart: always
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Rails environment
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      RAILS_SERVE_STATIC_FILES: "false"

      # Rails credentials (REQUIRED)
      RAILS_MASTER_KEY: ${RAILS_MASTER_KEY:?RAILS_MASTER_KEY is required}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:?SECRET_KEY_BASE is required}

      # Database configuration
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER}
      SHIOJIRI_RAINBOW_SEEKER_DATABASE_PASSWORD: ${POSTGRES_PASSWORD}

      # JWT configuration
      DEVISE_JWT_SECRET_KEY: ${DEVISE_JWT_SECRET_KEY:?DEVISE_JWT_SECRET_KEY is required}

      # CORS configuration
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-}

      # AWS S3 configuration (for image storage)
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-ap-northeast-1}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-}
      AWS_CLOUDFRONT_HOST: ${AWS_CLOUDFRONT_HOST:-}

      # External APIs
      WEATHER_API_KEY: ${WEATHER_API_KEY:-}
      FCM_SERVER_KEY: ${FCM_SERVER_KEY:-}

      # Performance tuning
      RAILS_MAX_THREADS: ${RAILS_MAX_THREADS:-5}
      WEB_CONCURRENCY: ${WEB_CONCURRENCY:-2}
      MALLOC_ARENA_MAX: "2"
    volumes:
      # Persistent storage for uploads (if using local storage)
      - rails_storage:/rails/storage
    ports:
      - "${API_PORT:-80}:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
      # Rolling update configuration
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s

  # ===========================================================================
  # Solid Queue Worker (Production)
  # ===========================================================================
  # Separate worker process for background jobs
  # ===========================================================================
  worker:
    image: ${DOCKER_REGISTRY:-}shiojiri-rainbow-backend:${IMAGE_TAG:-latest}
    container_name: shiojiri-rainbow-worker-prod
    restart: always
    depends_on:
      db:
        condition: service_healthy
      api:
        condition: service_healthy
    environment:
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      RAILS_MASTER_KEY: ${RAILS_MASTER_KEY}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER}
      SHIOJIRI_RAINBOW_SEEKER_DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      DEVISE_JWT_SECRET_KEY: ${DEVISE_JWT_SECRET_KEY}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-ap-northeast-1}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-}
      WEATHER_API_KEY: ${WEATHER_API_KEY:-}
      FCM_SERVER_KEY: ${FCM_SERVER_KEY:-}
      # Skip database preparation in worker (API container handles it)
      SKIP_DATABASE_PREPARE: "true"
    volumes:
      - rails_storage:/rails/storage
    command: ["./bin/rails", "solid_queue:start"]
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    name: shiojiri-rainbow-postgres-prod
  rails_storage:
    name: shiojiri-rainbow-storage-prod

# =============================================================================
# Networks
# =============================================================================
networks:
  default:
    name: shiojiri-rainbow-network-prod
