#!/bin/bash
# =============================================================================
# Pre-App-Boot Hook - Runs before each container starts
# =============================================================================
# This hook runs on the server before starting each container.
# Use it for health checks and environment validation.
# =============================================================================

set -e

echo "=> Pre-boot checks on server"

# Check if database is accessible (for web role)
if [ "${KAMAL_ROLE}" = "web" ]; then
    echo "   Checking database connectivity..."

    # Wait for database container if it's an accessory
    MAX_ATTEMPTS=30
    ATTEMPT=1

    while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
        if docker exec shiojiri-rainbow-seeker-db pg_isready -q 2>/dev/null; then
            echo "   Database is ready!"
            break
        fi

        if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "WARNING: Could not verify database connectivity"
            echo "   The app may fail to start if database is unavailable"
        fi

        echo "   Waiting for database... ($ATTEMPT/$MAX_ATTEMPTS)"
        sleep 2
        ATTEMPT=$((ATTEMPT + 1))
    done
fi

# Verify disk space
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 90 ]; then
    echo "WARNING: Disk usage is at ${DISK_USAGE}%!"
    echo "   Consider cleaning up old containers and images."
fi

# Check available memory
FREE_MEM=$(free -m | awk 'NR==2 {print $7}')
if [ "$FREE_MEM" -lt 512 ]; then
    echo "WARNING: Low available memory: ${FREE_MEM}MB"
fi

echo "=> Pre-boot checks passed!"
